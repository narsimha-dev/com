"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _readline = _interopRequireDefault(require("readline"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError("Cannot call a class as a function"); } }

function _defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if ("value" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } }

function _createClass(Constructor, protoProps, staticProps) { if (protoProps) _defineProperties(Constructor.prototype, protoProps); if (staticProps) _defineProperties(Constructor, staticProps); return Constructor; }

var Request =
/*#__PURE__*/
function () {
  function Request(config, client, response) {
    _classCallCheck(this, Request);

    this.config = config;
    this.client = client;
    this.response = response;
  } // Account


  _createClass(Request, [{
    key: "accountSetup",
    value: function accountSetup(key, secret, flags) {
      this._verifyCredentials(key, secret, this.response.accountSetup(this.config, key, secret, flags).bind(this.response));
    }
  }, {
    key: "_verifyCredentials",
    value: function _verifyCredentials(key, secret, callback) {
      var client = this.client.instanceWith(key, secret);
      client.account.checkBalance(callback);
    }
  }, {
    key: "accountInfo",
    value: function accountInfo() {
      this.response.accountInfo(this.client.instance());
    }
  }, {
    key: "accountBalance",
    value: function accountBalance() {
      this.client.instance().account.checkBalance(this.response.accountBalance.bind(this.response));
    } // Pricing

  }, {
    key: "priceSms",
    value: function priceSms(number) {
      number = stripPlus(number);
      this.client.instance().number.getPhonePricing('sms', number, this.response.priceSms.bind(this.response));
    }
  }, {
    key: "priceVoice",
    value: function priceVoice(number) {
      number = stripPlus(number);
      this.client.instance().number.getPhonePricing('voice', number, this.response.priceVoice.bind(this.response));
    }
  }, {
    key: "priceCountry",
    value: function priceCountry(country_code) {
      this.client.instance().number.getPricing(country_code, this.response.priceCountry.bind(this.response));
    } // Numbers

  }, {
    key: "numbersList",
    value: function numbersList(flags) {
      var options = {
        size: 100
      };

      if (flags.page) {
        options.index = flags.page;
      }

      if (flags.size) {
        options.size = flags.size;
      }

      if (flags.pattern) {
        options.pattern = flags.pattern;
        options.search_pattern = 1;
        if (options.pattern[0] === '*') options.search_pattern = 2;
        if (options.pattern.slice(-1) === '*') options.search_pattern = 0;
      }

      this.client.instance().number.get(options, this.response.numbersList(flags).bind(this.response));
    }
  }, {
    key: "numberSearch",
    value: function numberSearch(country_code, flags) {
      country_code = country_code.toUpperCase();
      var options = {
        features: [],
        size: 100
      };

      if (flags.voice) {
        options.features.push('VOICE');
      }

      if (flags.sms) {
        options.features.push('SMS');
      }

      if (flags.page) {
        options.index = flags.page;
      }

      if (flags.size) {
        options.size = flags.size;
      }

      if (flags.pattern) {
        options.pattern = flags.pattern;
        options.search_pattern = 1;
        if (options.pattern[0] === '*') options.search_pattern = 2;
        if (options.pattern.slice(-1) === '*') options.search_pattern = 0;
      }

      this.client.instance().number.search(country_code, options, this.response.numberSearch(flags).bind(this.response));
    }
  }, {
    key: "numberBuy",
    value: function numberBuy(numberOrPattern, command) {
      if (command.country_code) {
        this.numberBuyFromSearch(command.country_code, numberOrPattern, command);
      } else {
        this.numberBuyFromNumber(numberOrPattern, command);
      }
    }
  }, {
    key: "numberBuyFromNumber",
    value: function numberBuyFromNumber(number, flags) {
      var _this = this;

      number = stripPlus(number);
      confirm("Buying ".concat(number, ". This operation will charge your account."), this.response.emitter, flags, function () {
        _this.getCountryCode(number, flags, function (country_code) {
          _this.client.instance().number.buy(country_code, number, _this.response.numberBuyFromNumber(number).bind(_this.response));
        });
      });
    }
  }, {
    key: "numberBuyFromSearch",
    value: function numberBuyFromSearch(country_code, pattern, flags) {
      var _this2 = this;

      var options = {
        features: ['VOICE']
      };

      if (pattern) {
        options.pattern = pattern;
        options.search_pattern = 1;
        if (pattern[0] === '*') options.search_pattern = 2;
        if (pattern.slice(-1) === '*') options.search_pattern = 0;
      }

      this.client.instance().number.search(country_code, options, this.response.numberBuyFromPattern(function (number) {
        _this2.numberBuyFromNumber(number, flags);
      }));
    }
  }, {
    key: "numberCancel",
    value: function numberCancel(number, flags) {
      var _this3 = this;

      confirm('This operation can not be reversed.', this.response.emitter, flags, function () {
        _this3.getCountryCode(number, flags, function (country_code) {
          _this3.client.instance().number.cancel(country_code, number, _this3.response.numberCancel(number).bind(_this3.response));
        });
      });
    } // Applications

  }, {
    key: "applicationsList",
    value: function applicationsList(flags) {
      var options = {
        page_size: 100
      };

      if (flags.page) {
        options.index = flags.page;
      }

      if (flags.size) {
        options.page_size = flags.size;
      }

      this.client.instance().app.get(options, this.response.applicationsList(flags).bind(this.response));
    }
  }, {
    key: "applicationCreate",
    value: function applicationCreate(name, answer_url, event_url, flags) {
      var options = {};

      if (flags.answer_method) {
        options.answer_method = flags.answer_method;
      }

      if (flags.event_method) {
        options.event_method = flags.event_method;
      }

      this.client.instance().app.create(name, flags.type, answer_url, event_url, options, this.response.applicationCreate(flags));
    }
  }, {
    key: "applicationShow",
    value: function applicationShow(app_id) {
      this.client.instance().app.get(app_id, this.response.applicationShow.bind(this.response));
    }
  }, {
    key: "applicationUpdate",
    value: function applicationUpdate(app_id, name, answer_url, event_url, flags) {
      var options = {};

      if (flags.answer_method) {
        options.answer_method = flags.answer_method;
      }

      if (flags.event_method) {
        options.event_method = flags.event_method;
      }

      this.client.instance().app.update(app_id, name, flags.type, answer_url, event_url, options, this.response.applicationUpdate.bind(this.response));
    }
  }, {
    key: "applicationDelete",
    value: function applicationDelete(app_id, flags) {
      var _this4 = this;

      return confirm('This operation can not be reversed.', this.response.emitter, flags, function () {
        _this4.client.instance().app.delete(app_id, _this4.response.applicationDelete.bind(_this4.response));
      });
    }
  }, {
    key: "applicationNumbers",
    value: function applicationNumbers(app_id, flags) {
      var options = {};

      if (flags.page) {
        options.index = flags.page;
      }

      if (flags.size) {
        options.size = flags.size;
      }

      this.client.instance().number.get(options, this.response.applicationNumbers(app_id, flags).bind(this.response));
    } // links

  }, {
    key: "linkApp",
    value: function linkApp(number, app_id, flags) {
      this._link(number, flags, null, 'app', app_id);
    }
  }, {
    key: "linkSms",
    value: function linkSms(number, callback_url, flags) {
      this._link(number, flags, callback_url, 'sms', null);
    }
  }, {
    key: "linkTel",
    value: function linkTel(number, other_number, flags) {
      this._link(number, flags, null, 'tel', other_number, flags.voice_status_callback);
    }
  }, {
    key: "linkSip",
    value: function linkSip(number, sip_uri, flags) {
      this._link(number, flags, null, 'sip', sip_uri, flags.voice_status_callback);
    }
  }, {
    key: "linkVxml",
    value: function linkVxml(number, calback_url, flags) {
      this._link(number, flags, null, 'vxml', calback_url, flags.voice_status_callback);
    }
  }, {
    key: "unlinkApp",
    value: function unlinkApp(number, flags) {
      this._link(number, flags, null, 'app');
    }
  }, {
    key: "unlinkSms",
    value: function unlinkSms(number, flags) {
      this._link(number, flags, '', 'sms');
    }
  }, {
    key: "unlinkTel",
    value: function unlinkTel(number, flags) {
      this._link(number, flags, null, 'tel');
    }
  }, {
    key: "unlinkSip",
    value: function unlinkSip(number, flags) {
      this._link(number, flags, null, 'sip');
    }
  }, {
    key: "unlinkVxml",
    value: function unlinkVxml(number, flags) {
      this._link(number, flags, null, 'vxml');
    }
  }, {
    key: "numberUpdate",
    value: function numberUpdate(number, flags) {
      var _this5 = this;

      number = stripPlus(number);
      this.getCountryCode(number, flags, function (country_code) {
        var options = {};
        if (flags.mo_http_url) options.moHttpUrl = flags.mo_http_url;
        if (flags.voice_callback_type) options.voiceCallbackType = flags.voice_callback_type;
        if (flags.voice_callback_value) options.voiceCallbackValue = flags.voice_callback_value;
        if (flags.voice_status_callback) options.voiceStatusCallback = flags.voice_status_callback;

        _this5.client.instance().number.update(country_code, number, options, _this5.response.numberUpdate.bind(_this5.response));
      });
    }
  }, {
    key: "_link",
    value: function _link(number, flags, mo_http_url, voice_callback_type, voice_callback_value, voice_status_callback) {
      var _this6 = this;

      if (flags == null) {
        flags = {};
      }

      number = stripPlus(number);
      this.getCountryCode(number, flags, function (country_code) {
        var options = {};

        if (voice_callback_type == 'sms') {
          options.moHttpUrl = mo_http_url;
        } else {
          options.voiceCallbackType = voice_callback_type;
          if (voice_callback_value) options.voiceCallbackValue = voice_callback_value;
          if (voice_status_callback) options.voiceStatusCallback = voice_status_callback;
        }

        _this6.client.instance().number.update(country_code, number, options, _this6.response.numberUpdate.bind(_this6.response));
      });
    } // Insight

  }, {
    key: "insightBasic",
    value: function insightBasic(number) {
      number = stripPlus(number);
      this.client.instance().numberInsight.get({
        level: 'basic',
        number: number
      }, this.response.insightBasic.bind(this.response));
    }
  }, {
    key: "insightStandard",
    value: function insightStandard(number, flags) {
      var _this7 = this;

      number = stripPlus(number);
      confirm('This operation will charge your account.', this.response.emitter, flags, function () {
        _this7.client.instance().numberInsight.get({
          level: 'standard',
          number: number
        }, _this7.response.insightStandard.bind(_this7.response));
      });
    }
  }, {
    key: "insightAdvanced",
    value: function insightAdvanced(number, flags) {
      var _this8 = this;

      number = stripPlus(number);
      confirm('This operation will charge your account.', this.response.emitter, flags, function () {
        _this8.client.instance().numberInsight.get({
          level: 'advancedSync',
          number: number
        }, _this8.response.insightStandard.bind(_this8.response));
      });
    } // sending messages

  }, {
    key: "sendSms",
    value: function sendSms(to, text, flags) {
      var _this9 = this;

      confirm('This operation will charge your account.', this.response.emitter, flags, function () {
        _this9.client.instance().message.sendSms(flags.from, to, text.join(' '), _this9.response.sendSms.bind(_this9.response));
      });
    }
  }, {
    key: "generateJwt",
    value: function generateJwt(privateKey, claims, flags) {
      var token = null;
      var error = null;

      try {
        var fullClaims = {};

        if (flags.app_id) {
          fullClaims['application_id'] = flags.app_id;
        }

        claims.forEach(function (claim) {
          var nameValue = claim.split('=');

          if (nameValue.length !== 2) {
            throw new Error('All claims must be in the form `name=value`. Got: ' + nameValue);
          } // Using JSON.parse to cast 'exp' to number


          if (nameValue[0] === 'acl' || nameValue[0] === 'exp') {
            try {
              fullClaims[nameValue[0]] = JSON.parse(nameValue[1]);
            } catch (e) {
              fullClaims[nameValue[0]] = nameValue[1];
            }
          } else {
            fullClaims[nameValue[0]] = nameValue[1];
          }
        });
        token = this.client.definition().generateJwt(privateKey, fullClaims);
      } catch (ex) {
        error = ex;
      }

      this.response.generateJwt(error, token);
    }
  }, {
    key: "getCountryCode",
    value: function getCountryCode(number, flags, callback) {
      if (flags.country_code) {
        callback(flags.country_code);
      } else {
        this.client.instance().numberInsight.get({
          level: 'basic',
          number: number
        }, this.response.numberInsight(function (response) {
          callback(response.country_code);
        }));
      }
    }
  }]);

  return Request;
}();

var _default = Request; // private methods

exports.default = _default;

var confirm = function confirm(message, emitter, flags, callback) {
  if (flags.confirm) {
    callback();
  } else {
    var cli = _readline.default.createInterface(process.stdin, process.stdout);

    cli.question(message + '\n\nPlease type "confirm" to continue: ', function (answer) {
      if (answer.toString().trim() == 'confirm') {
        emitter.log(' ');
        callback();
      } else {
        process.exit(1);
      }

      cli.close();
      process.stdin.destroy();
    });
  }
};

var stripPlus = function stripPlus(number) {
  if (!number) {
    return number;
  }

  while (number.charAt(0) === '+') {
    number = number.substr(1);
  }

  return number;
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9yZXF1ZXN0LmpzIl0sIm5hbWVzIjpbIlJlcXVlc3QiLCJjb25maWciLCJjbGllbnQiLCJyZXNwb25zZSIsImtleSIsInNlY3JldCIsImZsYWdzIiwiX3ZlcmlmeUNyZWRlbnRpYWxzIiwiYWNjb3VudFNldHVwIiwiYmluZCIsImNhbGxiYWNrIiwiaW5zdGFuY2VXaXRoIiwiYWNjb3VudCIsImNoZWNrQmFsYW5jZSIsImFjY291bnRJbmZvIiwiaW5zdGFuY2UiLCJhY2NvdW50QmFsYW5jZSIsIm51bWJlciIsInN0cmlwUGx1cyIsImdldFBob25lUHJpY2luZyIsInByaWNlU21zIiwicHJpY2VWb2ljZSIsImNvdW50cnlfY29kZSIsImdldFByaWNpbmciLCJwcmljZUNvdW50cnkiLCJvcHRpb25zIiwic2l6ZSIsInBhZ2UiLCJpbmRleCIsInBhdHRlcm4iLCJzZWFyY2hfcGF0dGVybiIsInNsaWNlIiwiZ2V0IiwibnVtYmVyc0xpc3QiLCJ0b1VwcGVyQ2FzZSIsImZlYXR1cmVzIiwidm9pY2UiLCJwdXNoIiwic21zIiwic2VhcmNoIiwibnVtYmVyU2VhcmNoIiwibnVtYmVyT3JQYXR0ZXJuIiwiY29tbWFuZCIsIm51bWJlckJ1eUZyb21TZWFyY2giLCJudW1iZXJCdXlGcm9tTnVtYmVyIiwiY29uZmlybSIsImVtaXR0ZXIiLCJnZXRDb3VudHJ5Q29kZSIsImJ1eSIsIm51bWJlckJ1eUZyb21QYXR0ZXJuIiwiY2FuY2VsIiwibnVtYmVyQ2FuY2VsIiwicGFnZV9zaXplIiwiYXBwIiwiYXBwbGljYXRpb25zTGlzdCIsIm5hbWUiLCJhbnN3ZXJfdXJsIiwiZXZlbnRfdXJsIiwiYW5zd2VyX21ldGhvZCIsImV2ZW50X21ldGhvZCIsImNyZWF0ZSIsInR5cGUiLCJhcHBsaWNhdGlvbkNyZWF0ZSIsImFwcF9pZCIsImFwcGxpY2F0aW9uU2hvdyIsInVwZGF0ZSIsImFwcGxpY2F0aW9uVXBkYXRlIiwiZGVsZXRlIiwiYXBwbGljYXRpb25EZWxldGUiLCJhcHBsaWNhdGlvbk51bWJlcnMiLCJfbGluayIsImNhbGxiYWNrX3VybCIsIm90aGVyX251bWJlciIsInZvaWNlX3N0YXR1c19jYWxsYmFjayIsInNpcF91cmkiLCJjYWxiYWNrX3VybCIsIm1vX2h0dHBfdXJsIiwibW9IdHRwVXJsIiwidm9pY2VfY2FsbGJhY2tfdHlwZSIsInZvaWNlQ2FsbGJhY2tUeXBlIiwidm9pY2VfY2FsbGJhY2tfdmFsdWUiLCJ2b2ljZUNhbGxiYWNrVmFsdWUiLCJ2b2ljZVN0YXR1c0NhbGxiYWNrIiwibnVtYmVyVXBkYXRlIiwibnVtYmVySW5zaWdodCIsImxldmVsIiwiaW5zaWdodEJhc2ljIiwiaW5zaWdodFN0YW5kYXJkIiwidG8iLCJ0ZXh0IiwibWVzc2FnZSIsInNlbmRTbXMiLCJmcm9tIiwiam9pbiIsInByaXZhdGVLZXkiLCJjbGFpbXMiLCJ0b2tlbiIsImVycm9yIiwiZnVsbENsYWltcyIsImZvckVhY2giLCJjbGFpbSIsIm5hbWVWYWx1ZSIsInNwbGl0IiwibGVuZ3RoIiwiRXJyb3IiLCJKU09OIiwicGFyc2UiLCJlIiwiZGVmaW5pdGlvbiIsImdlbmVyYXRlSnd0IiwiZXgiLCJjbGkiLCJyZWFkbGluZSIsImNyZWF0ZUludGVyZmFjZSIsInByb2Nlc3MiLCJzdGRpbiIsInN0ZG91dCIsInF1ZXN0aW9uIiwiYW5zd2VyIiwidG9TdHJpbmciLCJ0cmltIiwibG9nIiwiZXhpdCIsImNsb3NlIiwiZGVzdHJveSIsImNoYXJBdCIsInN1YnN0ciJdLCJtYXBwaW5ncyI6Ijs7Ozs7OztBQUFBOzs7Ozs7Ozs7O0lBRU1BLE87OztBQUNKLG1CQUFZQyxNQUFaLEVBQW9CQyxNQUFwQixFQUE0QkMsUUFBNUIsRUFBc0M7QUFBQTs7QUFDcEMsU0FBS0YsTUFBTCxHQUFjQSxNQUFkO0FBQ0EsU0FBS0MsTUFBTCxHQUFjQSxNQUFkO0FBQ0EsU0FBS0MsUUFBTCxHQUFnQkEsUUFBaEI7QUFDRCxHLENBQ0Q7Ozs7O2lDQUVhQyxHLEVBQUtDLE0sRUFBUUMsSyxFQUFPO0FBQy9CLFdB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akMsRUFBd0NELE9BQU8sQ0FBQ0UsTUFBaEQsQ0FBWjs7QUFDQUwsSUFBQUEsR0FBRyxDQUFDTSxRQUFKLENBQWEzQixPQUFPLEdBQUcseUNBQXZCLEVBQWtFLFVBQUM0QixNQUFELEVBQVk7QUFDNUUsVUFBSUEsTUFBTSxDQUFDQyxRQUFQLEdBQWtCQyxJQUFsQixNQUE0QixTQUFoQyxFQUEyQztBQUN6QzFFLFFBQUFBLE9BQU8sQ0FBQzJFLEdBQVIsQ0FBWSxHQUFaO0FBQ0EvRyxRQUFBQSxRQUFRO0FBQ1QsT0FIRCxNQUdPO0FBQ0x3RyxRQUFBQSxPQUFPLENBQUNRLElBQVIsQ0FBYSxDQUFiO0FBQ0Q7O0FBRURYLE1BQUFBLEdBQUcsQ0FBQ1ksS0FBSjtBQUNBVCxNQUFBQSxPQUFPLENBQUNDLEtBQVIsQ0FBY1MsT0FBZDtBQUNELEtBVkQ7QUFXRDtBQUNGLENBakJEOztBQW1CQSxJQUFNMUcsU0FBUyxHQUFHLFNBQVpBLFNBQVksQ0FBVUQsTUFBVixFQUFrQjtBQUNsQyxNQUFJLENBQUNBLE1BQUwsRUFBYTtBQUFFLFdBQU9BLE1BQVA7QUFBZ0I7O0FBQy9CLFNBQU9BLE1BQU0sQ0FBQzRHLE1BQVAsQ0FBYyxDQUFkLE1BQXFCLEdBQTVCLEVBQWlDO0FBQy9CNUcsSUFBQUEsTUFBTSxHQUFHQSxNQUFNLENBQUM2RyxNQUFQLENBQWMsQ0FBZCxDQUFUO0FBQ0Q7O0FBQ0QsU0FBTzdHLE1BQVA7QUFDRCxDQU5EIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHJlYWRsaW5lIGZyb20gJ3JlYWRsaW5lJztcblxuY2xhc3MgUmVxdWVzdCB7XG4gIGNvbnN0cnVjdG9yKGNvbmZpZywgY2xpZW50LCByZXNwb25zZSkge1xuICAgIHRoaXMuY29uZmlnID0gY29uZmlnO1xuICAgIHRoaXMuY2xpZW50ID0gY2xpZW50O1xuICAgIHRoaXMucmVzcG9uc2UgPSByZXNwb25zZTtcbiAgfVxuICAvLyBBY2NvdW50XG5cbiAgYWNjb3VudFNldHVwKGtleSwgc2VjcmV0LCBmbGFncykge1xuICAgIHRoaXMuX3ZlcmlmeUNyZWRlbnRpYWxzKGtleSwgc2VjcmV0LCB0aGlzLnJlc3BvbnNlLmFjY291bnRTZXR1cCh0aGlzLmNvbmZpZywga2V5LCBzZWNyZXQsIGZsYWdzKS5iaW5kKHRoaXMucmVzcG9uc2UpKTtcbiAgfVxuXG4gIF92ZXJpZnlDcmVkZW50aWFscyhrZXksIHNlY3JldCwgY2FsbGJhY2spIHtcbiAgICBjb25zdCBjbGllbnQgPSB0aGlzLmNsaWVudC5pbnN0YW5jZVdpdGgoa2V5LCBzZWNyZXQpO1xuICAgIGNsaWVudC5hY2NvdW50LmNoZWNrQmFsYW5jZShjYWxsYmFjayk7XG4gIH1cblxuICBhY2NvdW50SW5mbygpIHtcbiAgICB0aGlzLnJlc3BvbnNlLmFjY291bnRJbmZvKHRoaXMuY2xpZW50Lmluc3RhbmNlKCkpO1xuICB9XG5cbiAgYWNjb3VudEJhbGFuY2UoKSB7XG4gICAgdGhpcy5jbGllbnQuaW5zdGFuY2UoKS5hY2NvdW50LmNoZWNrQmFsYW5jZSh0aGlzLnJlc3BvbnNlLmFjY291bnRCYWxhbmNlLmJpbmQodGhpcy5yZXNwb25zZSkpO1xuICB9XG5cbiAgLy8gUHJpY2luZ1xuXG4gIHByaWNlU21zKG51bWJlcikge1xuICAgIG51bWJlciA9IHN0cmlwUGx1cyhudW1iZXIpO1xuICAgIHRoaXMuY2xpZW50Lmluc3RhbmNlKCkubnVtYmVyLmdldFBob25lUHJpY2luZygnc21zJywgbnVtYmVyLCB0aGlzLnJlc3BvbnNlLnByaWNlU21zLmJpbmQodGhpcy5yZXNwb25zZSkpO1xuICB9XG5cbiAgcHJpY2VWb2ljZShudW1iZXIpIHtcbiAgICBudW1iZXIgPSBzdHJpcFBsdXMobnVtYmVyKTtcbiAgICB0aGlzLmNsaWVudC5pbnN0YW5jZSgpLm51bWJlci5nZXRQaG9uZVByaWNpbmcoJ3ZvaWNlJywgbnVtYmVyLCB0aGlzLnJlc3BvbnNlLnByaWNlVm9pY2UuYmluZCh0aGlzLnJlc3BvbnNlKSk7XG4gIH1cblxuICBwcmljZUNvdW50cnkoY291bnRyeV9jb2RlKSB7XG4gICAgdGhpcy5jbGllbnQuaW5zdGFuY2UoKS5udW1iZXIuZ2V0UHJpY2luZyhjb3VudHJ5X2NvZGUsIHRoaXMucmVzcG9uc2UucHJpY2VDb3VudHJ5LmJpbmQodGhpcy5yZXNwb25zZSkpO1xuICB9XG5cbiAgLy8gTnVtYmVyc1xuXG4gIG51bWJlcnNMaXN0KGZsYWdzKSB7XG4gICAgY29uc3Qgb3B0aW9ucyA9IHsgc2l6ZTogMTAwIH07XG4gICAgaWYgKGZsYWdzLnBhZ2UpIHsgb3B0aW9ucy5pbmRleCA9IGZsYWdzLnBhZ2U7IH1cbiAgICBpZiAoZmxhZ3Muc2l6ZSkgeyBvcHRpb25zLnNpemUgPSBmbGFncy5zaXplOyB9XG5cbiAgICBpZiAoZmxhZ3MucGF0dGVybikge1xuICAgICAgb3B0aW9ucy5wYXR0ZXJuID0gZmxhZ3MucGF0dGVybjtcbiAgICAgIG9wdGlvbnMuc2VhcmNoX3BhdHRlcm4gPSAxO1xuICAgICAgaWYgKG9wdGlvbnMucGF0dGVyblswXSA9PT0gJyonKSBvcHRpb25zLnNlYXJjaF9wYXR0ZXJuID0gMjtcbiAgICAgIGlmIChvcHRpb25zLnBhdHRlcm4uc2xpY2UoLTEpID09PSAnKicpIG9wdGlvbnMuc2VhcmNoX3BhdHRlcm4gPSAwO1xuICAgIH1cblxuICAgIHRoaXMuY2xpZW50Lmluc3RhbmNlKCkubnVtYmVyLmdldChvcHRpb25zLCB0aGlzLnJlc3BvbnNlLm51bWJlcnNMaXN0KGZsYWdzKS5iaW5kKHRoaXMucmVzcG9uc2UpKTtcbiAgfVxuXG4gIG51bWJlclNlYXJjaChjb3VudHJ5X2NvZGUsIGZsYWdzKSB7XG4gICAgY291bnRyeV9jb2RlID0gY291bnRyeV9jb2RlLnRvVXBwZXJDYXNlKCk7XG5cbiAgICBjb25zdCBvcHRpb25zID0geyBmZWF0dXJlczogW10sIHNpemU6IDEwMCB9O1xuICAgIGlmIChmbGFncy52b2ljZSkgeyBvcHRpb25zLmZlYXR1cmVzLnB1c2goJ1ZPSUNFJyk7IH1cbiAgICBpZiAoZmxhZ3Muc21zKSB7IG9wdGlvbnMuZmVhdHVyZXMucHVzaCgnU01TJyk7IH1cbiAgICBpZiAoZmxhZ3MucGFnZSkgeyBvcHRpb25zLmluZGV4ID0gZmxhZ3MucGFnZTsgfVxuICAgIGlmIChmbGFncy5zaXplKSB7IG9wdGlvbnMuc2l6ZSA9IGZsYWdzLnNpemU7IH1cblxuICAgIGlmIChmbGFncy5wYXR0ZXJuKSB7XG4gICAgICBvcHRpb25zLnBhdHRlcm4gPSBmbGFncy5wYXR0ZXJuO1xuICAgICAgb3B0aW9ucy5zZWFyY2hfcGF0dGVybiA9IDE7XG4gICAgICBpZiAob3B0aW9ucy5wYXR0ZXJuWzBdID09PSAnKicpIG9wdGlvbnMuc2VhcmNoX3BhdHRlcm4gPSAyO1xuICAgICAgaWYgKG9wdGlvbnMucGF0dGVybi5zbGljZSgtMSkgPT09ICcqJykgb3B0aW9ucy5zZWFyY2hfcGF0dGVybiA9IDA7XG4gICAgfVxuXG4gICAgdGhpcy5jbGllbnQuaW5zdGFuY2UoKS5udW1iZXIuc2VhcmNoKGNvdW50cnlfY29kZSwgb3B0aW9ucywgdGhpcy5yZXNwb25zZS5udW1iZXJTZWFyY2goZmxhZ3MpLmJpbmQodGhpcy5yZXNwb25zZSkpO1xuICB9XG5cbiAgbnVtYmVyQnV5KG51bWJlck9yUGF0dGVybiwgY29tbWFuZCkge1xuICAgIGlmIChjb21tYW5kLmNvdW50cnlfY29kZSkge1xuICAgICAgdGhpcy5udW1iZXJCdXlGcm9tU2VhcmNoKGNvbW1hbmQuY291bnRyeV9jb2RlLCBudW1iZXJPclBhdHRlcm4sIGNvbW1hbmQpO1xuICAgIH1cbiAgICBlbHNlIHtcbiAgICAgIHRoaXMubnVtYmVyQnV5RnJvbU51bWJlcihudW1iZXJPclBhdHRlcm4sIGNvbW1hbmQpO1xuICAgIH1cbiAgfVxuXG4gIG51bWJlckJ1eUZyb21OdW1iZXIobnVtYmVyLCBmbGFncykge1xuICAgIG51bWJlciA9IHN0cmlwUGx1cyhudW1iZXIpO1xuICAgIGNvbmZpcm0oYEJ1eWluZyAke251bWJlcn0uIFRoaXMgb3BlcmF0aW9uIHdpbGwgY2hhcmdlIHlvdXIgYWNjb3VudC5gLCB0aGlzLnJlc3BvbnNlLmVtaXR0ZXIsIGZsYWdzLCAoKSA9PiB7XG4gICAgICB0aGlzLmdldENvdW50cnlDb2RlKG51bWJlciwgZmxhZ3MsIChjb3VudHJ5X2NvZGUpID0+IHtcbiAgICAgICAgdGhpcy5jbGllbnQuaW5zdGFuY2UoKS5udW1iZXIuYnV5KGNvdW50cnlfY29kZSwgbnVtYmVyLCB0aGlzLnJlc3BvbnNlLm51bWJlckJ1eUZyb21OdW1iZXIobnVtYmVyKS5iaW5kKHRoaXMucmVzcG9uc2UpKTtcbiAgICAgIH0pO1xuICAgIH0pO1xuICB9XG5cbiAgbnVtYmVyQnV5RnJvbVNlYXJjaChjb3VudHJ5X2NvZGUsIHBhdHRlcm4sIGZsYWdzKSB7XG4gICAgY29uc3Qgb3B0aW9ucyA9IHsgZmVhdHVyZXM6IFsnVk9JQ0UnXSB9O1xuXG4gICAgaWYgKHBhdHRlcm4pIHtcbiAgICAgIG9wdGlvbnMucGF0dGVybiA9IHBhdHRlcm47XG4gICAgICBvcHRpb25zLnNlYXJjaF9wYXR0ZXJuID0gMTtcbiAgICAgIGlmIChwYXR0ZXJuWzBdID09PSAnKicpIG9wdGlvbnMuc2VhcmNoX3BhdHRlcm4gPSAyO1xuICAgICAgaWYgKHBhdHRlcm4uc2xpY2UoLTEpID09PSAnKicpIG9wdGlvbnMuc2VhcmNoX3BhdHRlcm4gPSAwO1xuICAgIH1cblxuICAgIHRoaXMuY2xpZW50Lmluc3RhbmNlKCkubnVtYmVyLnNlYXJjaChjb3VudHJ5X2NvZGUsIG9wdGlvbnMsIHRoaXMucmVzcG9uc2UubnVtYmVyQnV5RnJvbVBhdHRlcm4oKG51bWJlcikgPT4ge1xuICAgICAgdGhpcy5udW1iZXJCdXlGcm9tTnVtYmVyKG51bWJlciwgZmxhZ3MpO1xuICAgIH0pKTtcbiAgfVxuXG4gIG51bWJlckNhbmNlbChudW1iZXIsIGZsYWdzKSB7XG4gICAgY29uZmlybSgnVGhpcyBvcGVyYXRpb24gY2FuIG5vdCBiZSByZXZlcnNlZC4nLCB0aGlzLnJlc3BvbnNlLmVtaXR0ZXIsIGZsYWdzLCAoKSA9PiB7XG4gICAgICB0aGlzLmdldENvdW50cnlDb2RlKG51bWJlciwgZmxhZ3MsIChjb3VudHJ5X2NvZGUpID0+IHtcbiAgICAgICAgdGhpcy5jbGllbnQuaW5zdGFuY2UoKS5udW1iZXIuY2FuY2VsKGNvdW50cnlfY29kZSwgbnVtYmVyLCB0aGlzLnJlc3BvbnNlLm51bWJlckNhbmNlbChudW1iZXIpLmJpbmQodGhpcy5yZXNwb25zZSkpO1xuICAgICAgfSk7XG4gICAgfSk7XG4gIH1cblxuICAvLyBBcHBsaWNhdGlvbnNcblxuICBhcHBsaWNhdGlvbnNMaXN0KGZsYWdzKSB7XG4gICAgY29uc3Qgb3B0aW9ucyA9IHsgcGFnZV9zaXplOiAxMDAgfTtcbiAgICBpZiAoZmxhZ3MucGFnZSkgeyBvcHRpb25zLmluZGV4ID0gZmxhZ3MucGFnZTsgfVxuICAgIGlmIChmbGFncy5zaXplKSB7IG9wdGlvbnMucGFnZV9zaXplID0gZmxhZ3Muc2l6ZTsgfVxuXG4gICAgdGhpcy5jbGllbnQuaW5zdGFuY2UoKS5hcHAuZ2V0KG9wdGlvbnMsIHRoaXMucmVzcG9uc2UuYXBwbGljYXRpb25zTGlzdChmbGFncykuYmluZCh0aGlzLnJlc3BvbnNlKSk7XG4gIH1cblxuICBhcHBsaWNhdGlvbkNyZWF0ZShuYW1lLCBhbnN3ZXJfdXJsLCBldmVudF91cmwsIGZsYWdzKSB7XG4gICAgY29uc3Qgb3B0aW9ucyA9IHt9O1xuICAgIGlmIChmbGFncy5hbnN3ZXJfbWV0aG9kKSB7IG9wdGlvbnMuYW5zd2VyX21ldGhvZCA9IGZsYWdzLmFuc3dlcl9tZXRob2Q7IH1cbiAgICBpZiAoZmxhZ3MuZXZlbnRfbWV0aG9kKSB7IG9wdGlvbnMuZXZlbnRfbWV0aG9kID0gZmxhZ3MuZXZlbnRfbWV0aG9kOyB9XG5cbiAgICB0aGlzLmNsaWVudC5pbnN0YW5jZSgpLmFwcC5jcmVhdGUobmFtZSwgZmxhZ3MudHlwZSwgYW5zd2VyX3VybCwgZXZlbnRfdXJsLCBvcHRpb25zLCB0aGlzLnJlc3BvbnNlLmFwcGxpY2F0aW9uQ3JlYXRlKGZsYWdzKSk7XG4gIH1cblxuICBhcHBsaWNhdGlvblNob3coYXBwX2lkKSB7XG4gICAgdGhpcy5jbGllbnQuaW5zdGFuY2UoKS5hcHAuZ2V0KGFwcF9pZCwgdGhpcy5yZXNwb25zZS5hcHBsaWNhdGlvblNob3cuYmluZCh0aGlzLnJlc3BvbnNlKSk7XG4gIH1cblxuICBhcHBsaWNhdGlvblVwZGF0ZShhcHBfaWQsIG5hbWUsIGFuc3dlcl91cmwsIGV2ZW50X3VybCwgZmxhZ3MpIHtcbiAgICBjb25zdCBvcHRpb25zID0ge307XG4gICAgaWYgKGZsYWdzLmFuc3dlcl9tZXRob2QpIHsgb3B0aW9ucy5hbnN3ZXJfbWV0aG9kID0gZmxhZ3MuYW5zd2VyX21ldGhvZDsgfVxuICAgIGlmIChmbGFncy5ldmVudF9tZXRob2QpIHsgb3B0aW9ucy5ldmVudF9tZXRob2QgPSBmbGFncy5ldmVudF9tZXRob2Q7IH1cblxuICAgIHRoaXMuY2xpZW50Lmluc3RhbmNlKCkuYXBwLnVwZGF0ZShhcHBfaWQsIG5hbWUsIGZsYWdzLnR5cGUsIGFuc3dlcl91cmwsIGV2ZW50X3VybCwgb3B0aW9ucywgdGhpcy5yZXNwb25zZS5hcHBsaWNhdGlvblVwZGF0ZS5iaW5kKHRoaXMucmVzcG9uc2UpKTtcbiAgfVxuXG4gIGFwcGxpY2F0aW9uRGVsZXRlKGFwcF9pZCwgZmxhZ3MpIHtcbiAgICByZXR1cm4gY29uZmlybSgnVGhpcyBvcGVyYXRpb24gY2FuIG5vdCBiZSByZXZlcnNlZC4nLCB0aGlzLnJlc3BvbnNlLmVtaXR0ZXIsIGZsYWdzLCAoKSA9PiB7XG4gICAgICB0aGlzLmNsaWVudC5pbnN0YW5jZSgpLmFwcC5kZWxldGUoYXBwX2lkLCB0aGlzLnJlc3BvbnNlLmFwcGxpY2F0aW9uRGVsZXRlLmJpbmQodGhpcy5yZXNwb25zZSkpO1xuICAgIH0pO1xuICB9XG5cbiAgYXBwbGljYXRpb25OdW1iZXJzKGFwcF9pZCwgZmxhZ3MpIHtcbiAgICBjb25zdCBvcHRpb25zID0ge307XG4gICAgaWYgKGZsYWdzLnBhZ2UpIHsgb3B0aW9ucy5pbmRleCA9IGZsYWdzLnBhZ2U7IH1cbiAgICBpZiAoZmxhZ3Muc2l6ZSkgeyBvcHRpb25zLnNpemUgPSBmbGFncy5zaXplOyB9XG5cbiAgICB0aGlzLmNsaWVudC5pbnN0YW5jZSgpLm51bWJlci5nZXQob3B0aW9ucywgdGhpcy5yZXNwb25zZS5hcHBsaWNhdGlvbk51bWJlcnMoYXBwX2lkLCBmbGFncykuYmluZCh0aGlzLnJlc3BvbnNlKSk7XG4gIH1cblxuICAvLyBsaW5rc1xuXG4gIGxpbmtBcHAobnVtYmVyLCBhcHBfaWQsIGZsYWdzKSB7XG4gICAgdGhpcy5fbGluayhudW1iZXIsIGZsYWdzLCBudWxsLCAnYXBwJywgYXBwX2lkKTtcbiAgfVxuXG4gIGxpbmtTbXMobnVtYmVyLCBjYWxsYmFja191cmwsIGZsYWdzKSB7XG4gICAgdGhpcy5fbGluayhudW1iZXIsIGZsYWdzLCBjYWxsYmFja191cmwsICdzbXMnLCBudWxsKTtcbiAgfVxuXG4gIGxpbmtUZWwobnVtYmVyLCBvdGhlcl9udW1iZXIsIGZsYWdzKSB7XG4gICAgdGhpcy5fbGluayhudW1iZXIsIGZsYWdzLCBudWxsLCAndGVsJywgb3RoZXJfbnVtYmVyLCBmbGFncy52b2ljZV9zdGF0dXNfY2FsbGJhY2spO1xuICB9XG5cbiAgbGlua1NpcChudW1iZXIsIHNpcF91cmksIGZsYWdzKSB7XG4gICAgdGhpcy5fbGluayhudW1iZXIsIGZsYWdzLCBudWxsLCAnc2lwJywgc2lwX3VyaSwgZmxhZ3Mudm9pY2Vfc3RhdHVzX2NhbGxiYWNrKTtcbiAgfVxuXG4gIGxpbmtWeG1sKG51bWJlciwgY2FsYmFja191cmwsIGZsYWdzKSB7XG4gICAgdGhpcy5fbGluayhudW1iZXIsIGZsYWdzLCBudWxsLCAndnhtbCcsIGNhbGJhY2tfdXJsLCBmbGFncy52b2ljZV9zdGF0dXNfY2FsbGJhY2spO1xuICB9XG5cbiAgdW5saW5rQXBwKG51bWJlciwgZmxhZ3MpIHtcbiAgICB0aGlzLl9saW5rKG51bWJlciwgZmxhZ3MsIG51bGwsICdhcHAnKTtcbiAgfVxuXG4gIHVubGlua1NtcyhudW1iZXIsIGZsYWdzKSB7XG4gICAgdGhpcy5fbGluayhudW1iZXIsIGZsYWdzLCAnJywgJ3NtcycpO1xuICB9XG5cbiAgdW5saW5rVGVsKG51bWJlciwgZmxhZ3MpIHtcbiAgICB0aGlzLl9saW5rKG51bWJlciwgZmxhZ3MsIG51bGwsICd0ZWwnKTtcbiAgfVxuXG4gIHVubGlua1NpcChudW1iZXIsIGZsYWdzKSB7XG4gICAgdGhpcy5fbGluayhudW1iZXIsIGZsYWdzLCBudWxsLCAnc2lwJyk7XG4gIH1cblxuICB1bmxpbmtWeG1sKG51bWJlciwgZmxhZ3MpIHtcbiAgICB0aGlzLl9saW5rKG51bWJlciwgZmxhZ3MsIG51bGwsICd2eG1sJyk7XG4gIH1cblxuICBudW1iZXJVcGRhdGUobnVtYmVyLCBmbGFncykge1xuICAgIG51bWJlciA9IHN0cmlwUGx1cyhudW1iZXIpO1xuICAgIHRoaXMuZ2V0Q291bnRyeUNvZGUobnVtYmVyLCBmbGFncywgKGNvdW50cnlfY29kZSkgPT4ge1xuICAgICAgY29uc3Qgb3B0aW9ucyA9IHt9O1xuICAgICAgaWYgKGZsYWdzLm1vX2h0dHBfdXJsKSBvcHRpb25zLm1vSHR0cFVybCA9IGZsYWdzLm1vX2h0dHBfdXJsO1xuICAgICAgaWYgKGZsYWdzLnZvaWNlX2NhbGxiYWNrX3R5cGUpIG9wdGlvbnMudm9pY2VDYWxsYmFja1R5cGUgPSBmbGFncy52b2ljZV9jYWxsYmFja190eXBlO1xuICAgICAgaWYgKGZsYWdzLnZvaWNlX2NhbGxiYWNrX3ZhbHVlKSBvcHRpb25zLnZvaWNlQ2FsbGJhY2tWYWx1ZSA9IGZsYWdzLnZvaWNlX2NhbGxiYWNrX3ZhbHVlO1xuICAgICAgaWYgKGZsYWdzLnZvaWNlX3N0YXR1c19jYWxsYmFjaykgb3B0aW9ucy52b2ljZVN0YXR1c0NhbGxiYWNrID0gZmxhZ3Mudm9pY2Vfc3RhdHVzX2NhbGxiYWNrO1xuICAgICAgdGhpcy5jbGllbnQuaW5zdGFuY2UoKS5udW1iZXIudXBkYXRlKGNvdW50cnlfY29kZSwgbnVtYmVyLCBvcHRpb25zLCB0aGlzLnJlc3BvbnNlLm51bWJlclVwZGF0ZS5iaW5kKHRoaXMucmVzcG9uc2UpKTtcbiAgICB9KTtcbiAgfVxuXG4gIF9saW5rKG51bWJlciwgZmxhZ3MsIG1vX2h0dHBfdXJsLCB2b2ljZV9jYWxsYmFja190eXBlLCB2b2ljZV9jYWxsYmFja192YWx1ZSwgdm9pY2Vfc3RhdHVzX2NhbGxiYWNrKSB7XG4gICAgaWYgKGZsYWdzID09IG51bGwpIHsgZmxhZ3MgPSB7fTsgfVxuICAgIG51bWJlciA9IHN0cmlwUGx1cyhudW1iZXIpO1xuICAgIHRoaXMuZ2V0Q291bnRyeUNvZGUobnVtYmVyLCBmbGFncywgKGNvdW50cnlfY29kZSkgPT4ge1xuICAgICAgY29uc3Qgb3B0aW9ucyA9IHt9O1xuXG4gICAgICBpZiAodm9pY2VfY2FsbGJhY2tfdHlwZSA9PSAnc21zJykge1xuICAgICAgICBvcHRpb25zLm1vSHR0cFVybCA9IG1vX2h0dHBfdXJsO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgb3B0aW9ucy52b2ljZUNhbGxiYWNrVHlwZSA9IHZvaWNlX2NhbGxiYWNrX3R5cGU7XG4gICAgICAgIGlmICh2b2ljZV9jYWxsYmFja192YWx1ZSkgb3B0aW9ucy52b2ljZUNhbGxiYWNrVmFsdWUgPSB2b2ljZV9jYWxsYmFja192YWx1ZTtcbiAgICAgICAgaWYgKHZvaWNlX3N0YXR1c19jYWxsYmFjaykgb3B0aW9ucy52b2ljZVN0YXR1c0NhbGxiYWNrID0gdm9pY2Vfc3RhdHVzX2NhbGxiYWNrO1xuICAgICAgfVxuXG4gICAgICB0aGlzLmNsaWVudC5pbnN0YW5jZSgpLm51bWJlci51cGRhdGUoY291bnRyeV9jb2RlLCBudW1iZXIsIG9wdGlvbnMsIHRoaXMucmVzcG9uc2UubnVtYmVyVXBkYXRlLmJpbmQodGhpcy5yZXNwb25zZSkpO1xuICAgIH0pO1xuICB9XG5cbiAgLy8gSW5zaWdodFxuXG4gIGluc2lnaHRCYXNpYyhudW1iZXIpIHtcbiAgICBudW1iZXIgPSBzdHJpcFBsdXMobnVtYmVyKTtcbiAgICB0aGlzLmNsaWVudC5pbnN0YW5jZSgpLm51bWJlckluc2lnaHQuZ2V0KHsgbGV2ZWw6ICdiYXNpYycsIG51bWJlcjogbnVtYmVyIH0sIHRoaXMucmVzcG9uc2UuaW5zaWdodEJhc2ljLmJpbmQodGhpcy5yZXNwb25zZSkpO1xuICB9XG5cbiAgaW5zaWdodFN0YW5kYXJkKG51bWJlciwgZmxhZ3MpIHtcbiAgICBudW1iZXIgPSBzdHJpcFBsdXMobnVtYmVyKTtcbiAgICBjb25maXJtKCdUaGlzIG9wZXJhdGlvbiB3aWxsIGNoYXJnZSB5b3VyIGFjY291bnQuJywgdGhpcy5yZXNwb25zZS5lbWl0dGVyLCBmbGFncywgKCkgPT4ge1xuICAgICAgdGhpcy5jbGllbnQuaW5zdGFuY2UoKS5udW1iZXJJbnNpZ2h0LmdldCh7IGxldmVsOiAnc3RhbmRhcmQnLCBudW1iZXI6IG51bWJlciB9LCB0aGlzLnJlc3BvbnNlLmluc2lnaHRTdGFuZGFyZC5iaW5kKHRoaXMucmVzcG9uc2UpKTtcbiAgICB9KTtcbiAgfVxuXG4gIGluc2lnaHRBZHZhbmNlZChudW1iZXIsIGZsYWdzKSB7XG4gICAgbnVtYmVyID0gc3RyaXBQbHVzKG51bWJlcik7XG4gICAgY29uZmlybSgnVGhpcyBvcGVyYXRpb24gd2lsbCBjaGFyZ2UgeW91ciBhY2NvdW50LicsIHRoaXMucmVzcG9uc2UuZW1pdHRlciwgZmxhZ3MsICgpID0+IHtcbiAgICAgIHRoaXMuY2xpZW50Lmluc3RhbmNlKCkubnVtYmVySW5zaWdodC5nZXQoeyBsZXZlbDogJ2FkdmFuY2VkU3luYycsIG51bWJlcjogbnVtYmVyIH0sIHRoaXMucmVzcG9uc2UuaW5zaWdodFN0YW5kYXJkLmJpbmQodGhpcy5yZXNwb25zZSkpO1xuICAgIH0pO1xuICB9XG5cbiAgLy8gc2VuZGluZyBtZXNzYWdlc1xuXG4gIHNlbmRTbXModG8sIHRleHQsIGZsYWdzKSB7XG4gICAgY29uZmlybSgnVGhpcyBvcGVyYXRpb24gd2lsbCBjaGFyZ2UgeW91ciBhY2NvdW50LicsIHRoaXMucmVzcG9uc2UuZW1pdHRlciwgZmxhZ3MsICgpID0+IHtcbiAgICAgIHRoaXMuY2xpZW50Lmluc3RhbmNlKCkubWVzc2FnZS5zZW5kU21zKGZsYWdzLmZyb20sIHRvLCB0ZXh0LmpvaW4oJyAnKSwgdGhpcy5yZXNwb25zZS5zZW5kU21zLmJpbmQodGhpcy5yZXNwb25zZSkpO1xuICAgIH0pO1xuICB9XG5cbiAgZ2VuZXJhdGVKd3QocHJpdmF0ZUtleSwgY2xhaW1zLCBmbGFncykge1xuICAgIGxldCB0b2tlbiA9IG51bGw7XG4gICAgbGV0IGVycm9yID0gbnVsbDtcblxuICAgIHRyeSB7XG4gICAgICBjb25zdCBmdWxsQ2xhaW1zID0ge307XG4gICAgICBpZiAoZmxhZ3MuYXBwX2lkKSB7XG4gICAgICAgIGZ1bGxDbGFpbXNbJ2FwcGxpY2F0aW9uX2lkJ10gPSBmbGFncy5hcHBfaWQ7XG4gICAgICB9XG5cbiAgICAgIGNsYWltcy5mb3JFYWNoKChjbGFpbSkgPT4ge1xuICAgICAgICBjb25zdCBuYW1lVmFsdWUgPSBjbGFpbS5zcGxpdCgnPScpO1xuICAgICAgICBpZiAobmFtZVZhbHVlLmxlbmd0aCAhPT0gMikge1xuICAgICAgICAgIHRocm93IG5ldyBFcnJvcignQWxsIGNsYWltcyBtdXN0IGJlIGluIHRoZSBmb3JtIGBuYW1lPXZhbHVlYC4gR290OiAnICsgbmFtZVZhbHVlKTtcbiAgICAgICAgfVxuICAgICAgICAvLyBVc2luZyBKU09OLnBhcnNlIHRvIGNhc3QgJ2V4cCcgdG8gbnVtYmVyXG4gICAgICAgIGlmIChuYW1lVmFsdWVbMF0gPT09ICdhY2wnIHx8IG5hbWVWYWx1ZVswXSA9PT0gJ2V4cCcpIHtcbiAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgZnVsbENsYWltc1tuYW1lVmFsdWVbMF1dID0gSlNPTi5wYXJzZShuYW1lVmFsdWVbMV0pO1xuICAgICAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgICAgIGZ1bGxDbGFpbXNbbmFtZVZhbHVlWzBdXSA9IG5hbWVWYWx1ZVsxXTtcbiAgICAgICAgICB9XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgZnVsbENsYWltc1tuYW1lVmFsdWVbMF1dID0gbmFtZVZhbHVlWzFdO1xuICAgICAgICB9XG5cbiAgICAgIH0pO1xuXG4gICAgICB0b2tlbiA9IHRoaXMuY2xpZW50LmRlZmluaXRpb24oKS5nZW5lcmF0ZUp3dChwcml2YXRlS2V5LCBmdWxsQ2xhaW1zKTtcbiAgICB9XG4gICAgY2F0Y2ggKGV4KSB7XG4gICAgICBlcnJvciA9IGV4O1xuICAgIH1cbiAgICB0aGlzLnJlc3BvbnNlLmdlbmVyYXRlSnd0KGVycm9yLCB0b2tlbik7XG4gIH1cblxuICBnZXRDb3VudHJ5Q29kZShudW1iZXIsIGZsYWdzLCBjYWxsYmFjaykge1xuICAgIGlmIChmbGFncy5jb3VudHJ5X2NvZGUpIHtcbiAgICAgIGNhbGxiYWNrKGZsYWdzLmNvdW50cnlfY29kZSk7XG4gICAgfVxuICAgIGVsc2Uge1xuICAgICAgdGhpcy5jbGllbnQuaW5zdGFuY2UoKS5udW1iZXJJbnNpZ2h0LmdldCh7IGxldmVsOiAnYmFzaWMnLCBudW1iZXI6IG51bWJlciB9LCB0aGlzLnJlc3BvbnNlLm51bWJlckluc2lnaHQoKHJlc3BvbnNlKSA9PiB7XG4gICAgICAgIGNhbGxiYWNrKHJlc3BvbnNlLmNvdW50cnlfY29kZSk7XG4gICAgICB9KSk7XG4gICAgfVxuICB9XG59XG5cbmV4cG9ydCBkZWZhdWx0IFJlcXVlc3Q7XG5cbi8vIHByaXZhdGUgbWV0aG9kc1xuXG5jb25zdCBjb25maXJtID0gZnVuY3Rpb24gKG1lc3NhZ2UsIGVtaXR0ZXIsIGZsYWdzLCBjYWxsYmFjaykge1xuICBpZiAoZmxhZ3MuY29uZmlybSkge1xuICAgIGNhbGxiYWNrKCk7XG4gIH0gZWxzZSB7XG4gICAgY29uc3QgY2xpID0gcmVhZGxpbmUuY3JlYXRlSW50ZXJmYWNlKHByb2Nlc3Muc3RkaW4sIHByb2Nlc3Muc3Rkb3V0KTtcbiAgICBjbGkucXVlc3Rpb24obWVzc2FnZSArICdcXG5cXG5QbGVhc2UgdHlwZSBcImNvbmZpcm1cIiB0byBjb250aW51ZTogJywgKGFuc3dlcikgPT4ge1xuICAgICAgaWYgKGFuc3dlci50b1N0cmluZygpLnRyaW0oKSA9PSAnY29uZmlybScpIHtcbiAgICAgICAgZW1pdHRlci5sb2coJyAnKTtcbiAgICAgICAgY2FsbGJhY2soKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHByb2Nlc3MuZXhpdCgxKTtcbiAgICAgIH1cblxuICAgICAgY2xpLmNsb3NlKCk7XG4gICAgICBwcm9jZXNzLnN0ZGluLmRlc3Ryb3koKTtcbiAgICB9KTtcbiAgfVxufTtcblxuY29uc3Qgc3RyaXBQbHVzID0gZnVuY3Rpb24gKG51bWJlcikge1xuICBpZiAoIW51bWJlcikgeyByZXR1cm4gbnVtYmVyOyB9XG4gIHdoaWxlIChudW1iZXIuY2hhckF0KDApID09PSAnKycpIHtcbiAgICBudW1iZXIgPSBudW1iZXIuc3Vic3RyKDEpO1xuICB9XG4gIHJldHVybiBudW1iZXI7XG59O1xuIl19