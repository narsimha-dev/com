"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

function _typeof(obj) { if (typeof Symbol === "function" && typeof Symbol.iterator === "symbol") { _typeof = function _typeof(obj) { return typeof obj; }; } else { _typeof = function _typeof(obj) { return obj && typeof Symbol === "function" && obj.constructor === Symbol && obj !== Symbol.prototype ? "symbol" : typeof obj; }; } return _typeof(obj); }

function _slicedToArray(arr, i) { return _arrayWithHoles(arr) || _iterableToArrayLimit(arr, i) || _nonIterableRest(); }

function _nonIterableRest() { throw new TypeError("Invalid attempt to destructure non-iterable instance"); }

function _iterableToArrayLimit(arr, i) { var _arr = []; var _n = true; var _d = false; var _e = undefined; try { for (var _i = arr[Symbol.iterator](), _s; !(_n = (_s = _i.next()).done); _n = true) { _arr.push(_s.value); if (i && _arr.length === i) break; } } catch (err) { _d = true; _e = err; } finally { try { if (!_n && _i["return"] != null) _i["return"](); } finally { if (_d) throw _e; } } return _arr; }

function _arrayWithHoles(arr) { if (Array.isArray(arr)) return arr; }

function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError("Cannot call a class as a function"); } }

function _defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if ("value" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } }

function _createClass(Constructor, protoProps, staticProps) { if (protoProps) _defineProperties(Constructor.prototype, protoProps); if (staticProps) _defineProperties(Constructor, staticProps); return Constructor; }

var Emitter =
/*#__PURE__*/
function () {
  function Emitter() {
    _classCallCheck(this, Emitter);

    this.silenced = false;
    this.amplified = false;
    this.debugging = false;
  }

  _createClass(Emitter, [{
    key: "quiet",
    value: function quiet() {
      var silenced = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : true;
      this.silenced = silenced;
    }
  }, {
    key: "verbose",
    value: function verbose() {
      var amplified = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : true;
      this.amplified = amplified;
    }
  }, {
    key: "debug",
    value: function debug() {
      var debugging = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : true;
      this.debugging = debugging;
    }
  }, {
    key: "log",
    value: function log(message, amplified_message) {
      if (this.amplified && amplified_message) message = amplified_message;
      if (!this.silenced && message) console.log(message); // eslint-disable-line no-console
    }
  }, {
    key: "warn",
    value: function warn(message) {
      if (!this.silenced) console.warn(message); // eslint-disable-line no-console
    }
  }, {
    key: "error",
    value: function error(message) {
      console.error(message); // eslint-disable-line no-console

      process.exit(1);
    }
  }, {
    key: "debugger",
    value: function _debugger(message) {
      if (this.debugging) {
        console.log(message);
      } // eslint-disable-line no-console

    }
  }, {
    key: "table",
    value: function table(data, regular_keys, verbose_keys) {
      var _this = this;

      var keys = this.amplified ? verbose_keys : regular_keys;
      var records = mapRecords(data, keys);

      if (this.amplified) {
        records.unshift(keys);
      }

      var lengths = valueLengths(records);
      records.forEach(function (record, row) {
        var message = formatMessage(record, lengths);

        _this.log(message);

        if (row == 0 && _this.amplified) _this.log(right('', message.length, '-'));
      });
    }
  }, {
    key: "list",
    value: function list(message, verbose_data) {
      if (this.amplified || !message) {
        var _message = formatList(verbose_data);

        this.log(_message);
      } else {
        this.log(message);
      }
    }
  }, {
    key: "pagination",
    value: function pagination(flags, data) {
      var page = parseInt(flags.page || 1);
      var size = parseInt(flags.size || 100);
      var total = data.count;
      var start = size * (page - 1) + 1;
      var end = Math.min(start + size - 1, total);
      if (this.amplified) this.log("Item ".concat(start, "-").concat(end, " of ").concat(total, "\n"));
    }
  }]);

  return Emitter;
}();

var _default = Emitter;
exports.default = _default;

var right = function right() {
  var string = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : '';
  var size = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : 0;
  var padding = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : ' ';

  if (string.length >= size) {
    return string;
  }

  var max = size - string.length;

  for (var i = 0; i < max; i++) {
    string += padding;
  }

  return string;
};

var mapRecords = function mapRecords(records, keys) {
  return records.map(function (record) {
    var mappedRecord = keys.map(function (key) {
      return "".concat(record[key]);
    });
    return mappedRecord;
  });
};

var valueLengths = function valueLengths(records) {
  var lengths = [];
  records.forEach(function (record) {
    record.forEach(function (value, index) {
      lengths[index] = Math.max(lengths[index] || 0, value.length);
    });
  });
  return lengths;
};

var formatMessage = function formatMessage(record, lengths) {
  return record.reduce(function (previous, current, index) {
    if (index == 1) {
      previous = right(previous, lengths[index - 1]);
    }

    return "".concat(previous, " | ").concat(right(current, lengths[index]));
  });
};

var formatList = function formatList() {
  var data = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : {};
  var prefix = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : '';
  var entries = Object.keys(data).map(function (key) {
    return [key, data[key]];
  });
  return entries.reduce(function (message, _ref) {
    var _ref2 = _slicedToArray(_ref, 2),
        key = _ref2[0],
        value = _ref2[1];

    if (_typeof(value) === 'object') {
      return message + formatList(value, prefix + key + '.');
    }

    return message + "[".concat(prefix).concat(key, "]\n") + "".concat(data[key], "\n\n");
  }, '');
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9lbWl0dGVyLmpzIl0sIm5hbWVzIjpbIkVtaXR0ZXIiLCJzaWxlbmNlZCIsImFtcGxpZmllZCIsImRlYnVnZ2luZyIsIm1lc3NhZ2UiLCJhbXBsaWZpZWRfbWVzc2FnZSIsImNvbnNvbGUiLCJsb2ciLCJ3YXJuIiwiZXJyb3IiLCJwcm9jZXNzIiwiZXhpdCIsImRhdGEiLCJyZWd1bGFyX2tleXMiLCJ2ZXJib3NlX2tleXMiLCJrZXlzIiwicmVjb3JkcyIsIm1hcFJlY29yZHMiLCJ1bnNoaWZ0IiwibGVuZ3RocyIsInZhbHVlTGVuZ3RocyIsImZvckVhY2giLCJyZWNvcmQiLCJyb3ciLCJmb3JtYXRNZXNzYWdlIiwicmlnaHQiLCJsZW5ndGgiLCJ2ZXJib3NlX2RhdGEiLCJmb3JtYXRMaXN0IiwiZmxhZ3MiLCJwYWdlIiwicGFyc2VJbnQiLCJzaXplIiwidG90YWwiLCJjb3VudCIsInN0YXJ0IiwiZW5kIiwiTWF0aCIsIm1pbiIsInN0cmluZyIsInBhZGRpbmciLCJtYXgiLCJpIiwibWFwIiwibWFwcGVkUmVjb3JkIiwia2V5IiwidmFsdWUiLCJpbmRleCIsInJlZHVjZSIsInByZXZpb3VzIiwiY3VycmVudCIsInByZWZpeCIsImVudHJpZXMiLCJPYmplY3QiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0lBQU1BLE87OztBQUNKLHFCQUFjO0FBQUE7O0FBQ1osU0FBS0MsUUFBTCxHQUFnQixLQUFoQjtBQUNBLFNBQUtDLFNBQUwsR0FBaUIsS0FBakI7QUFDQSxTQUFLQyxTQUFMLEdBQWlCLEtBQWpCO0FBQ0Q7Ozs7NEJBRXNCO0FBQUEsVUFBakJGLFFBQWlCLHVFQUFOLElBQU07QUFDckIsV0FBS0EsUUFBTCxHQUFnQkEsUUFBaEI7QUFDRDs7OzhCQUV5QjtBQUFBLFVBQWxCQyxTQUFrQix1RUFBTixJQUFNO0FBQ3hCLFdBQUtBLFNBQUwsR0FBaUJBLFNBQWpCO0FBQ0Q7Ozs0QkFFdUI7QUFBQSxVQUFsQkMsU0FBa0IsdUVB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QUQsRUFBUUssTUFBTSxHQUFDTixHQUFQLEdBQVcsR0FBbkIsQ0FBM0I7QUFDRDs7QUFDRCxXQUFPekMsT0FBTyxjQUFPK0MsTUFBUCxTQUFnQk4sR0FBaEIsUUFBUCxhQUFxQ2pDLElBQUksQ0FBQ2lDLEdBQUQsQ0FBekMsU0FBUDtBQUNELEdBTE0sRUFLSixFQUxJLENBQVA7QUFNRCxDQVJEIiwic291cmNlc0NvbnRlbnQiOlsiY2xhc3MgRW1pdHRlciB7XG4gIGNvbnN0cnVjdG9yKCkge1xuICAgIHRoaXMuc2lsZW5jZWQgPSBmYWxzZTtcbiAgICB0aGlzLmFtcGxpZmllZCA9IGZhbHNlO1xuICAgIHRoaXMuZGVidWdnaW5nID0gZmFsc2U7XG4gIH1cblxuICBxdWlldChzaWxlbmNlZCA9IHRydWUpIHtcbiAgICB0aGlzLnNpbGVuY2VkID0gc2lsZW5jZWQ7XG4gIH1cblxuICB2ZXJib3NlKGFtcGxpZmllZCA9IHRydWUpIHtcbiAgICB0aGlzLmFtcGxpZmllZCA9IGFtcGxpZmllZDtcbiAgfVxuXG4gIGRlYnVnKGRlYnVnZ2luZyA9IHRydWUpIHtcbiAgICB0aGlzLmRlYnVnZ2luZyA9IGRlYnVnZ2luZztcbiAgfVxuXG4gIGxvZyhtZXNzYWdlLCBhbXBsaWZpZWRfbWVzc2FnZSkge1xuICAgIGlmICh0aGlzLmFtcGxpZmllZCAmJiBhbXBsaWZpZWRfbWVzc2FnZSkgbWVzc2FnZSA9IGFtcGxpZmllZF9tZXNzYWdlO1xuICAgIGlmICghdGhpcy5zaWxlbmNlZCAmJiBtZXNzYWdlKSBjb25zb2xlLmxvZyhtZXNzYWdlKTsgLy8gZXNsaW50LWRpc2FibGUtbGluZSBuby1jb25zb2xlXG4gIH1cblxuICB3YXJuKG1lc3NhZ2UpIHtcbiAgICBpZiAoIXRoaXMuc2lsZW5jZWQpIGNvbnNvbGUud2FybihtZXNzYWdlKTsgLy8gZXNsaW50LWRpc2FibGUtbGluZSBuby1jb25zb2xlXG4gIH1cblxuICBlcnJvcihtZXNzYWdlKSB7XG4gICAgY29uc29sZS5lcnJvcihtZXNzYWdlKTsgLy8gZXNsaW50LWRpc2FibGUtbGluZSBuby1jb25zb2xlXG4gICAgcHJvY2Vzcy5leGl0KDEpO1xuICB9XG5cbiAgZGVidWdnZXIobWVzc2FnZSkge1xuICAgIGlmICh0aGlzLmRlYnVnZ2luZykgeyBjb25zb2xlLmxvZyhtZXNzYWdlKTsgfSAvLyBlc2xpbnQtZGlzYWJsZS1saW5lIG5vLWNvbnNvbGVcbiAgfVxuXG4gIHRhYmxlKGRhdGEsIHJlZ3VsYXJfa2V5cywgdmVyYm9zZV9rZXlzKSB7XG4gICAgY29uc3Qga2V5cyA9IHRoaXMuYW1wbGlmaWVkID8gdmVyYm9zZV9rZXlzIDogcmVndWxhcl9rZXlzO1xuICAgIGNvbnN0IHJlY29yZHMgPSBtYXBSZWNvcmRzKGRhdGEsIGtleXMpO1xuICAgIGlmICh0aGlzLmFtcGxpZmllZCkgeyByZWNvcmRzLnVuc2hpZnQoa2V5cyk7IH1cbiAgICBjb25zdCBsZW5ndGhzID0gdmFsdWVMZW5ndGhzKHJlY29yZHMpO1xuXG4gICAgcmVjb3Jkcy5mb3JFYWNoKChyZWNvcmQsIHJvdykgPT4ge1xuICAgICAgY29uc3QgbWVzc2FnZSA9IGZvcm1hdE1lc3NhZ2UocmVjb3JkLCBsZW5ndGhzKTtcbiAgICAgIHRoaXMubG9nKG1lc3NhZ2UpO1xuICAgICAgaWYgKHJvdyA9PSAwICYmIHRoaXMuYW1wbGlmaWVkKSB0aGlzLmxvZyhyaWdodCgnJywgbWVzc2FnZS5sZW5ndGgsICctJykpO1xuICAgIH0pO1xuICB9XG5cbiAgbGlzdChtZXNzYWdlLCB2ZXJib3NlX2RhdGEpIHtcbiAgICBpZiAodGhpcy5hbXBsaWZpZWQgfHwgIW1lc3NhZ2UpIHtcbiAgICAgIGNvbnN0IG1lc3NhZ2UgPSBmb3JtYXRMaXN0KHZlcmJvc2VfZGF0YSk7XG4gICAgICB0aGlzLmxvZyhtZXNzYWdlKTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy5sb2cobWVzc2FnZSk7XG4gICAgfVxuICB9XG5cbiAgcGFnaW5hdGlvbihmbGFncywgZGF0YSkge1xuICAgIGNvbnN0IHBhZ2UgID0gcGFyc2VJbnQoZmxhZ3MucGFnZSB8fCAxKTtcbiAgICBjb25zdCBzaXplICA9IHBhcnNlSW50KGZsYWdzLnNpemUgfHwgMTAwKTtcbiAgICBjb25zdCB0b3RhbCA9IGRhdGEuY291bnQ7XG4gICAgY29uc3Qgc3RhcnQgPSBzaXplKihwYWdlLTEpICsgMTtcbiAgICBjb25zdCBlbmQgICA9IE1hdGgubWluKHN0YXJ0ICsgc2l6ZSAtIDEsIHRvdGFsKTtcblxuICAgIGlmICh0aGlzLmFtcGxpZmllZCkgdGhpcy5sb2coYEl0ZW0gJHtzdGFydH0tJHtlbmR9IG9mICR7dG90YWx9XFxuYCk7XG4gIH1cbn1cblxuZXhwb3J0IGRlZmF1bHQgRW1pdHRlcjtcblxuY29uc3QgcmlnaHQgPSBmdW5jdGlvbihzdHJpbmcgPSAnJywgc2l6ZSA9IDAsIHBhZGRpbmcgPSAnICcpIHtcbiAgaWYgKHN0cmluZy5sZW5ndGggPj0gc2l6ZSkgeyByZXR1cm4gc3RyaW5nOyB9XG5cbiAgdmFyIG1heCA9IHNpemUgLSBzdHJpbmcubGVuZ3RoO1xuICBmb3IgKHZhciBpID0gMDsgaSA8IG1heDsgaSsrKSB7XG4gICAgc3RyaW5nICs9IHBhZGRpbmc7XG4gIH1cblxuICByZXR1cm4gc3RyaW5nO1xufTtcblxuY29uc3QgbWFwUmVjb3JkcyA9IGZ1bmN0aW9uKHJlY29yZHMsIGtleXMpIHtcbiAgcmV0dXJuIHJlY29yZHMubWFwKChyZWNvcmQpID0+IHtcbiAgICBjb25zdCBtYXBwZWRSZWNvcmQgPSBrZXlzLm1hcCgoa2V5KSA9PiB7XG4gICAgICByZXR1cm4gYCR7cmVjb3JkW2tleV19YDtcbiAgICB9KTtcbiAgICByZXR1cm4gbWFwcGVkUmVjb3JkO1xuICB9KTtcbn07XG5cbmNvbnN0IHZhbHVlTGVuZ3RocyA9IGZ1bmN0aW9uKHJlY29yZHMpIHtcbiAgY29uc3QgbGVuZ3RocyA9IFtdO1xuICByZWNvcmRzLmZvckVhY2goKHJlY29yZCkgPT4ge1xuICAgIHJlY29yZC5mb3JFYWNoKCh2YWx1ZSwgaW5kZXgpID0+IHtcbiAgICAgIGxlbmd0aHNbaW5kZXhdID0gTWF0aC5tYXgobGVuZ3Roc1tpbmRleF0gfHwgMCwgdmFsdWUubGVuZ3RoKTtcbiAgICB9KTtcbiAgfSk7XG4gIHJldHVybiBsZW5ndGhzO1xufTtcblxuY29uc3QgZm9ybWF0TWVzc2FnZSA9IGZ1bmN0aW9uKHJlY29yZCwgbGVuZ3Rocykge1xuICByZXR1cm4gcmVjb3JkLnJlZHVjZSgocHJldmlvdXMsIGN1cnJlbnQsIGluZGV4KSA9PiB7XG4gICAgaWYgKGluZGV4ID09IDEpIHsgcHJldmlvdXMgPSByaWdodChwcmV2aW91cywgbGVuZ3Roc1tpbmRleC0xXSk7IH1cbiAgICByZXR1cm4gYCR7cHJldmlvdXN9IHwgJHtyaWdodChjdXJyZW50LCBsZW5ndGhzW2luZGV4XSl9YDtcbiAgfSk7XG59O1xuXG5jb25zdCBmb3JtYXRMaXN0ID0gZnVuY3Rpb24oZGF0YSA9IHt9LCBwcmVmaXggPSAnJykge1xuICBjb25zdCBlbnRyaWVzID0gT2JqZWN0LmtleXMoZGF0YSkubWFwKGtleSA9PiBba2V5LCBkYXRhW2tleV1dKTtcbiAgcmV0dXJuIGVudHJpZXMucmVkdWNlKChtZXNzYWdlLCBba2V5LCB2YWx1ZV0pID0+IHtcbiAgICBpZiAodHlwZW9mKHZhbHVlKSA9PT0gJ29iamVjdCcpIHtcbiAgICAgIHJldHVybiBtZXNzYWdlICsgZm9ybWF0TGlzdCh2YWx1ZSwgcHJlZml4K2tleSsnLicpO1xuICAgIH1cbiAgICByZXR1cm4gbWVzc2FnZSArIGBbJHtwcmVmaXh9JHtrZXl9XVxcbmAgKyBgJHtkYXRhW2tleV19XFxuXFxuYDtcbiAgfSwgJycpO1xufTtcbiJdfQ==